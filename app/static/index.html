<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multimodal RAG Demo Console</title>
    <style>
      :root {
        color-scheme: dark light;
        font-family: "Segoe UI", system-ui, sans-serif;
      }
      body {
        margin: 0;
        padding: 24px;
        background: radial-gradient(circle at top, #1e293b, #0f172a 55%);
        color: #e2e8f0;
        min-height: 100vh;
      }
      h1,
      h2,
      h3 {
        color: #38bdf8;
        margin: 0 0 16px;
      }
      h2 {
        font-size: 1.35rem;
      }
      a {
        color: #38bdf8;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        gap: 24px;
      }
      section {
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.14);
        border-radius: 18px;
        padding: 26px;
        box-shadow: 0 24px 60px -20px rgba(56, 189, 248, 0.4);
        backdrop-filter: blur(18px);
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      input,
      textarea,
      button {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 12px 14px;
        margin-bottom: 14px;
        background: rgba(15, 23, 42, 0.6);
        color: #e2e8f0;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        font-size: 1rem;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      button {
        cursor: pointer;
        background: linear-gradient(135deg, #0ea5e9, #22d3ee);
        border: none;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        box-shadow: 0 18px 35px -18px rgba(34, 211, 238, 0.8);
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 22px 45px -18px rgba(34, 211, 238, 0.9);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      input:focus,
      textarea:focus {
        outline: none;
        border-color: #38bdf8;
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
      }
      .status {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        font-size: 0.92rem;
        line-height: 1.45;
        background: rgba(15, 23, 42, 0.5);
        border-left: 4px solid transparent;
        display: none;
      }
      .status.success {
        border-color: #22c55e;
      }
      .status.error {
        border-color: #ef4444;
      }
      .status.info {
        border-color: #38bdf8;
      }
      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
      }
      .jobs-list,
      .responses {
        display: grid;
        gap: 16px;
      }
      .card {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 14px;
        padding: 18px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.2);
        border: 1px solid rgba(56, 189, 248, 0.35);
        margin-bottom: 10px;
      }
      pre {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 12px;
        padding: 12px;
        overflow-x: auto;
        border: 1px solid rgba(148, 163, 184, 0.1);
      }
      details summary {
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 6px;
      }
      details[open] summary {
        color: #38bdf8;
      }
      @media (max-width: 640px) {
        body {
          padding: 16px;
        }
        section {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <section>
        <h1>Multimodal RAG Console</h1>
        <p>Upload PDFs, ingest YouTube transcripts + scene frames, poll job progress, and chat with grounded answers (Gemini Vision Pro).</p>
        <label for="apiKey">API Key</label>
        <input id="apiKey" type="text" placeholder="X-API-Key from your .env" />
        <button id="saveKey">Save API Key</button>
        <div id="authStatus" class="status info"></div>
      </section>

      <div class="grid-two">
        <section>
          <h2>Upload PDF</h2>
          <form id="pdfForm">
            <label for="pdfInput">Select PDF</label>
            <input id="pdfInput" type="file" accept="application/pdf" />
            <button type="submit">Process PDF</button>
          </form>
          <div id="pdfStatus" class="status info"></div>
        </section>

        <section>
          <h2>Ingest YouTube</h2>
          <form id="youtubeForm">
            <label for="youtubeUrl">YouTube URL</label>
            <input id="youtubeUrl" type="url" placeholder="https://youtu.be/..." />
            <button type="submit">Enqueue Ingestion</button>
          </form>
          <div id="youtubeStatus" class="status info"></div>
          <div class="jobs-list" id="jobsList"></div>
        </section>
      </div>

      <section>
        <h2>Chat</h2>
        <form id="chatForm">
          <label for="chatMessage">Question</label>
          <textarea id="chatMessage" placeholder="Ask something about your indexed content..."></textarea>

          <label for="chatVideoId">Optional video ID</label>
          <input id="chatVideoId" type="text" placeholder="Limit answer to a specific video (optional)" />

          <button type="submit">Send</button>
        </form>
        <div id="chatStatus" class="status info"></div>
        <div class="responses" id="responses"></div>
      </section>
    </div>

    <script>
      const apiKeyInput = document.getElementById("apiKey");
      const saveKeyButton = document.getElementById("saveKey");
      const authStatus = document.getElementById("authStatus");
      const pdfForm = document.getElementById("pdfForm");
      const pdfStatus = document.getElementById("pdfStatus");
      const youtubeForm = document.getElementById("youtubeForm");
      const youtubeStatus = document.getElementById("youtubeStatus");
      const jobsList = document.getElementById("jobsList");
      const chatForm = document.getElementById("chatForm");
      const chatStatus = document.getElementById("chatStatus");
      const responses = document.getElementById("responses");

      let apiKey = "";
      const activeJobs = new Map();

      function showStatus(el, message, type = "info") {
        el.textContent = message;
        el.className = `status ${type}`;
        el.style.display = "block";
      }

      function hideStatus(el) {
        el.style.display = "none";
      }

      function requireKey() {
        const key = apiKey.trim();
        if (!key) throw new Error("API key required. Save your key first.");
        return key;
      }

      function withApiKey(options = {}) {
        const headers = Object.assign({}, options.headers, { "X-API-Key": requireKey() });
        return { ...options, headers };
      }

      saveKeyButton.addEventListener("click", () => {
        apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
          showStatus(authStatus, "Please enter a valid API key.", "error");
          return;
        }
        localStorage.setItem("mrag-api-key", apiKey);
        showStatus(authStatus, "API key saved for this session.", "success");
      });

      (function restoreKey() {
        const stored = localStorage.getItem("mrag-api-key");
        if (stored) {
          apiKey = stored;
          apiKeyInput.value = stored;
          showStatus(authStatus, "Loaded API key from previous session.", "success");
        } else {
          showStatus(authStatus, "Enter your API key to get started.", "info");
        }
      })();

      pdfForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        try {
          requireKey();
          const file = document.getElementById("pdfInput").files[0];
          if (!file) throw new Error("Select a PDF file first.");

          showStatus(pdfStatus, "Uploading PDF...", "info");

          const formData = new FormData();
          formData.append("file", file);

          const response = await fetch("/process-pdf/", {
            method: "POST",
            headers: { "X-API-Key": apiKey },
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || response.statusText);
          }
          const result = await response.json();
          showStatus(
            pdfStatus,
            `PDF processed. Text chunks indexed: ${result.text_chunks_indexed}, images indexed: ${result.images_indexed}`,
            "success"
          );
        } catch (error) {
          showStatus(pdfStatus, `PDF upload failed: ${error.message}`, "error");
        }
      });

      youtubeForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        try {
          requireKey();
          const url = document.getElementById("youtubeUrl").value.trim();
          if (!url) throw new Error("Enter a valid YouTube URL.");

          showStatus(youtubeStatus, "Submitting ingestion job...", "info");

          const response = await fetch(
            "/ingest/youtube",
            withApiKey({
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url }),
            })
          );

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || response.statusText);
          }

          const result = await response.json();
          showStatus(youtubeStatus, `Ingestion started. Job ID: ${result.job_id}`, "success");
          trackJob(result.job_id);
        } catch (error) {
          showStatus(youtubeStatus, `Failed to enqueue video: ${error.message}`, "error");
        }
      });

      function trackJob(jobId) {
        if (activeJobs.has(jobId)) return;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="badge">Job ${jobId}</div>
          <p>Status: <strong data-status>pending</strong></p>
          <p>Progress: <strong data-progress>0%</strong></p>
          <pre data-payload style="display:none;"></pre>
        `;
        jobsList.prepend(card);
        const statusEl = card.querySelector("[data-status]");
        const progressEl = card.querySelector("[data-progress]");
        const payloadEl = card.querySelector("[data-payload]");

        const interval = setInterval(async () => {
          try {
            const response = await fetch(`/yt_status/${jobId}`, withApiKey());
            if (!response.ok) throw new Error(response.statusText);
            const data = await response.json();
            statusEl.textContent = data.state;
            if (typeof data.progress_pct !== "undefined") {
              progressEl.textContent = `${data.progress_pct}%`;
            }
            if (data.state === "SUCCESS") {
              payloadEl.style.display = "block";
              payloadEl.textContent = JSON.stringify(data.notes || data, null, 2);
              clearInterval(interval);
            } else if (data.state === "FAILURE") {
              payloadEl.style.display = "block";
              payloadEl.textContent = JSON.stringify(data, null, 2);
              card.classList.add("error");
              clearInterval(interval);
            }
          } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
          }
        }, 4000);

        activeJobs.set(jobId, interval);
      }

      chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        try {
          requireKey();
          const message = document.getElementById("chatMessage").value.trim();
          const videoId = document.getElementById("chatVideoId").value.trim();
          if (!message) throw new Error("Ask a question first.");

          showStatus(chatStatus, "Querying Gemini Vision Pro...", "info");

          const payload = { message };
          if (videoId) payload.video_id = videoId;

          const response = await fetch(
            "/chat_pro",
            withApiKey({
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            })
          );

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || response.statusText);
          }

          const data = await response.json();
          hideStatus(chatStatus);

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="badge">Gemini Vision Pro</div>
            <h3>Answer</h3>
            <p>${data.response.replace(/\n/g, "<br>")}</p>
            <details>
              <summary>Citations</summary>
              <pre>${JSON.stringify(data.citations, null, 2)}</pre>
            </details>
          `;
          responses.prepend(card);
          chatForm.reset();
        } catch (error) {
          showStatus(chatStatus, `Chat request failed: ${error.message}`, "error");
        }
      });
    </script>
  </body>
</html>
